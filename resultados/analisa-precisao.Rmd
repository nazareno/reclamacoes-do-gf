---
title: "Análise da precisão"
output: html_notebook
---

```{r, warning=FALSE}
library(tidyverse)
library(here)
library(modelr)
library(broom)
library(caret)

theme_set(theme_bw())
```

## Os dados

```{r carrega, warning=FALSE}
reclamacoes_raw = read_csv(here("data/reclamacoes-raw/reclamacoes-raw.csv"))
avaliacoes_raw = read_csv(here("data/avaliacoes/avaliacoes-20180222.csv"))
sentimentos = read_csv(here("data/sentimentos/sentimento.csv"))

reclamacoes_raw = reclamacoes_raw %>% 
    mutate(id = 1:n(), 
           comprimento_reclamacao = str_length(reclamacao), 
           nome_orgao = str_split(link, "/") %>% map_chr(~ .[[5]]))
```

`reclamacoes_l` tem um formato long em vez de wide (explicado [aqui](https://sejdemyr.github.io/r-tutorials/basics/wide-and-long/)).

```{r junta}
avaliacoes = avaliacoes_raw %>% 
    group_by(id_reclamação) %>% 
    summarise(insatisfação = median(insatisfação), 
              avaliadores = n())

reclamacoes = reclamacoes_raw %>% 
    inner_join(avaliacoes, by = c("id" = "id_reclamação")) %>% 
    left_join(sentimentos, by = "id")

reclamacoes_l = reclamacoes %>%  
    select(-palavras_op30, -palavras_sent) %>% 
    gather(key = "lexico", 
           value = "polaridade", 
           sentimento_op30, sentimento_sent)

```

Converte polaridades para escala 0-5

```{r, warning=FALSE}
max1 <- max(subset(reclamacoes_l, lexico == "sentimento_op30")$polaridade)
max2 <- max(subset(reclamacoes_l, lexico == "sentimento_sent")$polaridade)

reclamacoes_l = reclamacoes_l %>% 
     mutate(polaridade_normalizada = 
                if(lexico == "sentimento_op30") {
                    return(polaridade - (max1))
                }else {
                    return(polaridade - (max2))
                }
            )

min1 <- min(subset(reclamacoes_l, lexico == "sentimento_op30")$polaridade_normalizada)
min2 <- min(subset(reclamacoes_l, lexico == "sentimento_sent")$polaridade_normalizada)

reclamacoes_l = reclamacoes_l %>%
    mutate(polaridade_normalizada = 
               if(lexico == "sentimento_op30") {
                    return((5/min1) * polaridade_normalizada)
                }else {
                    return((5/min2) * polaridade_normalizada)
                }
    )
```

Calcula o erro por reclamação

```{r}
reclamacoes_l = reclamacoes_l %>% 
    mutate(erro = (insatisfação - polaridade_normalizada)**2)
```


## EDA

Inicial. Faça os gráficos a mais que achar necessário para entender os dados que temos de resultado.

```{r}
reclamacoes %>% 
    ggplot(aes(x = sentimento_op30, y = sentimento_sent)) + 
    geom_abline(slope = 1, intercept = 0, color = "grey") + 
    geom_count(alpha = .7) 
```

```{r}
reclamacoes_l %>% 
    ggplot(aes(x = insatisfação, y = polaridade_normalizada, group = insatisfação)) + 
    geom_jitter(alpha = .7)  + 
    facet_wrap(~ lexico)

reclamacoes_l %>% 
    ggplot(aes(x = insatisfação, y = erro, group = insatisfação)) + 
    geom_jitter(alpha = .5)  +
    # geom_boxplo() + 
    facet_wrap(~ lexico)
```


## Há relação entre o léxico e a precisão/erro?

Agora um modelo para responder sua pergunta.

```{r}
fit <- train(erro ~ lexico + nome_orgao,
             data = reclamacoes_l,
             method = "lm")
glance(fit$finalModel)

reclamacoes_l$linear_model_pred <- predict(fit, reclamacoes_l)

ggplot(data = reclamacoes_l, aes(x = linear_model_pred,
                                 y = erro))+
    labs(x ="Predição", y ="Observado", title ="Erro observado vs predito.") +
    geom_point(colour = "blue") +
    geom_abline(colour = "red")
```


Regressão múltipla foi utilizada para analisar se o Léxico e Nome do Orgão tem uma associação significativa com o erro na estimativa de instatisfação da reclemação. Os resultados da regressão indicam que um modelo baseado em tais fatores explicam apenas 9,19% da variância da variável de resposta (R2 = 0,09197). No gráfico acima, a reta em vermelho representa a faixa de valores observados e preditos são iguais e os pontos azuis representam o real valor.Nesse gráfico podemos notar uma grande divergencia entre os dados previstos e os observados.


Explicar as variaveis independente o impacto das variáveis independentes utilizadas seria muito custoso, visto que por serem variaveis qualitativas, são tratadas como 'dummy' pela regressão linear. A seguir, vamos tentar sumarizar melhor parte do impacto de tais variáveis no modelo.

```{r}
tidy(fit$finalModel)
```

Esse sumário nos mostra as variações das variaveis utilizadas e suas métricas frente ao modelo.O léxico 'sentimento_sent', por exemplo, tem um p-valor = 0.5376 e um valor estimado de 0.4234. Ao observar o sumário acima, é importante saber que p-valores com um alto grau de confiança(>(95%)) devem estar abaixo do valor 0.005.

O gráfico abaixo exibe as variáveis mais importantes para o modelo em uma escala de 0 a 100.
```{r}
plot(varImp(fit))
```

Por fim, concluímos que não foi possível identificar atravéz de regressão linear múltipla, uma relação significante entre o erro e o lexico utilizado.
